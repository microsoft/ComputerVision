# Unit Test steps
steps:

- bash: |
    echo "##vso[task.prependpath]/data/anaconda/bin"
  displayName: Add Conda to PATH

- bash: |
    conda env create -f classification/environment.yml
    source activate cvbp
    conda env list  
  displayName: 'Create and activate conda environment'

- script: |
    az login --service-principal -u $(spidentity) -p $(spsecret) --tenant $(sptenant)

- script: |
    az extension add --name azure-cli-ml

#- script: |
#    az ml workspace create --workspace-name $(workspacename) --exist-ok --resource-group $(resourcegroup)

- bash: |
    echo $OSTYPE
    if [ ! -d .azureml ]; then  mkdir .azureml; fi;
    if [ ! -f .azureml/config.json ];
    then echo -e "{\n    \"subscription_id\":\""$subscriptionid"\",    \"resource_group\":\""$resourcegroup"\",    \"workspace_name\":\""$workspacename"\",    \"location\":\""$location"\"\n}" > .azureml/config.json; fi;

- bash: |
    source activate cvbp
    python -m ipykernel install --user --name cvbp --display-name "cvbp"
    pytest tests/unit --junitxml=junit/test-unitttest.xml
  displayName: 'Run Unit tests'

#- script: |
#    az ml workspace delete --all-resources --resource-group $(resourcegroup) --subscription-id $(subscriptionid) --workspace-name $(workspacename)

- bash: |
      echo Remove Conda Environment
      conda remove -n cvbp --all -q --force -y
      conda env list
      echo Done Cleanup
  displayName: 'Cleanup Task'
  condition: always()

- task: PublishTestResults@2
  inputs:
    testResultsFiles: '**/test-unitttest.xml'
    testRunTitle: 'Test results for PyTest'
